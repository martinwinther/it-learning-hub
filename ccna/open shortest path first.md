# Open Shortest Path First

## Overview

Open Shortest Path First (OSPF) is an interior gateway protocol (IGP) that serves as a key building block of modern enterprise networks. OSPF is a link-state routing protocol that uses the Shortest Path First (SPF) algorithm, also called Dijkstra's algorithm, to calculate routes. OSPFv2 is used for IPv4 networks and is the focus of the CCNA exam.

## OSPF Fundamentals

### OSPF Name Components

- **Open**: OSPF is an open standard protocol, not Cisco proprietary
- **Shortest Path First**: Name of the algorithm (SPF/Dijkstra's algorithm) used to calculate routes
- All vendors are free to implement OSPF on their network devices

### OSPF Versions

- **OSPFv2**: Primarily used for IPv4 networks (CCNA exam focus)
- **OSPFv3**: Primarily used for IPv6 networks (can also be used for IPv4)
- All mentions of OSPF in CCNA context refer to OSPFv2

### Three Fundamental Steps

1. Form neighbor relationships with other OSPF-enabled routers
2. Exchange routing information to build a connectivity map of the network
3. Calculate the best routes to each destination

## Link-State Advertisements and Database

### Link-State Advertisements (LSAs)

- Routers exchange routing information using data structures called LSAs
- Each router creates an LSA with information about its connected networks
- LSAs are sent to neighboring routers, which forward them to other routers
- Process of sending LSAs to all routers in the area is called LSA flooding

### Link-State Database (LSDB)

- Each router organizes received LSAs in a database called the LSDB
- LSDB serves as the router's map of the network topology
- Used for calculating shortest path to each destination network
- All routers in the same OSPF area must have identical LSDBs

### LSA Types

For CCNA exam, be aware of three LSA types:

- **Type 1 (Router LSA)**: Generated by all routers, describes the router's links
- **Type 2 (Network LSA)**: Generated by the DR of a broadcast network, lists all routers on the segment
- **Type 5 (AS External LSA)**: Generated by ASBRs, advertises routes to external networks (e.g., default route to internet)

## OSPF Areas

### Single-Area OSPF

- Network is a single logical unit
- All routers share the same LSDB
- Suitable for small networks
- Highly recommended to use area 0 even in single-area designs

### Multi-Area OSPF

- Large networks divided into multiple smaller areas
- Minimizes negative effects of large single-area designs:
  - Smaller LSDBs use fewer memory resources
  - SPF algorithm takes less time and CPU resources
  - Network changes only advertised within local area
  - Network instability effects limited to single area

### Area Structure

- OSPF employs two-level hierarchical structure
- **Backbone area (Area 0)**: Central area to which all other areas connect
- **Non-backbone areas**: Must connect to area 0
- Traffic between non-backbone areas must pass through area 0

### OSPF Router Types

- **Internal router**: All OSPF-enabled interfaces are in the same area
- **Backbone router**: At least one interface is in area 0
- **Area border router (ABR)**: Connects one or more areas to area 0
- **Autonomous system boundary router (ASBR)**: Connects OSPF AS to external networks (e.g., internet)

### Route Types

- **Intra-area routes**: Routes to destinations in the same OSPF area as the router
- **Inter-area routes**: Routes to destinations in an area the router does not connect to
- **External routes**: Routes to external destinations advertised by an ASBR

## OSPF Cost and Metrics

### Cost Calculation

- OSPF's metric is called cost
- Route's cost is cumulative cost of each interface a packet must be sent out of to reach destination
- Cost of a link is calculated by: reference bandwidth / link bandwidth
- Default reference bandwidth is 100 Mbps
- If calculation results in value less than 1, OSPF cost is assigned as 1

### Default Cost Values

- 10 Mbps link = 10 (100/10)
- 100 Mbps link = 1 (100/100)
- 1,000 Mbps (1 Gbps) link = 1 (100/1000 = 0.1, rounded to 1)
- 10,000 Mbps (10 Gbps) link = 1 (100/10000 = 0.01, rounded to 1)

### Reference Bandwidth Adjustment

- Default 100 Mbps reference bandwidth causes all links 100 Mbps or greater to have same cost
- Can result in suboptimal route selection
- Adjust with: `auto-cost reference-bandwidth mbps` in router config mode
- Common practice: set to match fastest link in network
- **Important**: Configure same reference bandwidth on all routers to prevent routing loops

### Modifying Link Cost

Two methods to modify link cost:

1. **Direct cost configuration**: `ip ospf cost cost` in interface config mode (preferred)
2. **Bandwidth modification**: `bandwidth kbps` in interface config mode (affects other features like QoS)

Note: Modifying bandwidth value doesn't change actual interface speed; use `speed` command for that.

## OSPF Configuration

### Creating OSPF Process

- Command: `router ospf process-id` in global config mode
- Process ID is locally significant (doesn't need to match between routers)
- Can create multiple OSPF processes, but extremely rare in practice
- Process ID 1 is commonly used

### Router ID (RID)

- Unique 32-bit value that identifies router in OSPF AS
- Must be unique; cannot have two routers with same RID
- Determined in following order:
  1. Manual configuration with `router-id` command
  2. Highest IP address on operational loopback interface
  3. Highest IP address on operational physical interface
- View with: `show ip protocols`

### Loopback Interfaces

- Virtual router interface that is always up and reachable
- Provides stable, reliable interface for router identification
- Not dependent on status of particular physical port
- Create with: `interface loopback number`
- Standard to configure with /32 netmask (255.255.255.255)
- Highly recommended to configure on routers and activate OSPF on them

### Activating OSPF on Interfaces

Two methods:

#### Method 1: Network Command

- Command: `network ip-address wildcard-mask area area-id` in router config mode
- Specifies range of IP addresses; router activates OSPF on interfaces with IPs in range
- More complex but required knowledge for CCNA exam

#### Method 2: Interface Command (Simpler)

- Command: `ip ospf process-id area area-id` in interface config mode
- Explicitly specifies which interfaces OSPF should be activated on
- Simpler and more straightforward method

### Passive Interfaces

- Passive interface is OSPF-enabled but does not send OSPF hello messages
- Still advertises network prefix of interface to neighbors
- Prevents wasted hello messages on interfaces not connected to other routers
- Configure with: `passive-interface interface-name` in router config mode
- Alternative: `passive-interface default` then `no passive-interface interface-name` for specific interfaces
- Good practice: Configure loopback interfaces as passive

### Default Route Advertisement

- Configure default route on ASBR: `ip route 0.0.0.0 0.0.0.0 next-hop`
- Advertise to OSPF neighbors: `default-information originate` in router config mode
- Router must have default route in its own routing table first
- Makes router an ASBR (autonomous system boundary router)

## OSPF Neighbor Relationships

### OSPF Message Types

Five message types used by OSPF:

1. **Hello**: Neighbor discovery and maintenance
2. **Database Description (DBD)**: Summary of router's LSDB, used to check if LSDBs match
3. **Link-State Request (LSR)**: Requests specific LSAs from a neighbor
4. **Link-State Update (LSU)**: Sends specific LSAs to a neighbor
5. **Link-State Acknowledgment (LSAck)**: Acknowledges receipt of an LSU

### Neighbor States

Seven OSPF neighbor states:

1. **Down**: Router hasn't received any hello messages
2. **Init**: Router received hello but hello didn't include local router's RID
3. **2-Way**: Routers see and acknowledge each other (neighbors but haven't exchanged LSAs)
4. **ExStart**: Routers determine which will lead DBD exchange (Leader/Follower)
5. **Exchange**: Actual DBD exchange takes place
6. **Loading**: Routers request and send specific LSAs using LSR/LSU/LSAck
7. **Full**: Routers have synced LSDBs (adjacent/fully adjacent)

### Hello Messages

- Sent to multicast IP address 224.0.0.5 (all OSPF routers)
- Used for dynamically discovering OSPF neighbors
- Used for maintaining neighbor relationships
- Include local router's RID and RIDs of known neighbors
- Sent at regular intervals (hello timer)

### Hello and Dead Timers

- Default hello timer: 10 seconds
- Default dead timer: 40 seconds
- Dead timer: Router removes neighbor if no hello received for this duration
- If physical link failure detected, OSPF immediately removes neighbor (no need to wait for dead timer)
- Configure with: `ip ospf hello-interval seconds` and `ip ospf dead-interval seconds`

## OSPF Network Types

### Network Type Concept

- OSPF uses interface setting called network type to determine behavior over a network
- Network in this context means a connection between two or more routers (a segment)
- Network type influences:
  - OSPF message timers
  - Whether DR and BDR are elected
  - Whether all neighbor relationships become full adjacencies

### Broadcast Network Type

- Default network type on Ethernet interfaces (all speeds)
- Characteristics:
  - DR/BDR elected
  - Establish full adjacency only with DR and BDR
  - Neighbors dynamically discovered
  - Default timers: hello = 10, dead = 40

### Designated Router (DR) and Backup Designated Router (BDR)

- DR and BDR elected in 2-Way neighbor state
- Remaining routers become DROthers
- Purpose: Reduce amount of OSPF traffic in segment
- DROthers only establish full adjacency with DR and BDR
- DROthers remain in 2-Way state with each other
- DROthers send messages to multicast IP 224.0.0.6 (DR and BDR only)
- DR/BDR election is per segment, not per area

### DR/BDR Election

- Determined by:
  1. Highest interface priority (default 1)
  2. Highest RID (if priorities tied)
- Configure priority with: `ip ospf priority priority` in interface config mode
- Once elected, DR/BDR won't be preempted unless OSPF process is reset
- If DR fails, BDR immediately takes over; then election held for new BDR

### Point-to-Point Network Type

- Ideal for direct connections between two routers
- Characteristics:
  - No DR/BDR election
  - Establish full adjacency with neighbor
  - Neighbors dynamically discovered
  - Default timers: hello = 10, dead = 40
- Configure with: `ip ospf network point-to-point` in interface config mode
- Must configure on both sides of connection
- Default on serial interfaces (legacy WAN technology)

## OSPF Neighbor Requirements

For routers to become OSPF neighbors, the following must be met:

- **Area number must match**
- **Subnet (network address, netmask) must match**
- **OSPF process must not be shutdown**
- **RIDs must be unique** (one parameter that must NOT match)
- **Hello and dead timers must match**
- **Authentication settings must match**
- **IP MTU settings must match** (prevents full adjacency if mismatched)
- **Network type must match** (prevents LSDB sync if mismatched)

### Mismatch Consequences

- IP MTU mismatch: Routers stuck in ExStart/Exchange states, cannot establish full adjacency
- Network type mismatch: Routers establish full adjacency but cannot sync LSDBs, won't learn each other's routes

## Verification Commands

### General OSPF Information

- `show ip protocols`: View OSPF process, RID, areas, interfaces
- `show ip ospf interface brief`: View OSPF-enabled interfaces and their costs
- `show ip ospf interface [interface]`: View detailed interface information

### Neighbor Information

- `show ip ospf neighbor`: View OSPF neighbor table, states, and roles

### Routing Information

- `show ip route ospf`: View routes learned via OSPF
- `show ip route`: View all routes, including OSPF routes (marked with O)

### Database Information

- `show ip ospf database`: View LSDB contents (should be same on all routers in area)

## Troubleshooting OSPF

### Common Issues

- **Neighbors not forming**: Check area number, subnet, RID uniqueness, timers, authentication
- **Routes not appearing**: Verify network type matches, IP MTU matches, interfaces are not passive
- **Suboptimal routes**: Check reference bandwidth consistency, link costs
- **DR/BDR not elected**: Verify broadcast network type, check interface priorities
- **LSDB not syncing**: Check network type and IP MTU match on both sides

### Troubleshooting Steps

1. Verify OSPF is activated on correct interfaces
2. Check neighbor table: `show ip ospf neighbor`
3. Verify all neighbor requirements are met
4. Check routing table: `show ip route ospf`
5. Verify LSDB: `show ip ospf database`
6. Check interface status and OSPF configuration: `show ip ospf interface`

## Real-World Applications

- **Enterprise networks**: OSPF is standard for internal routing in large organizations
- **Multi-vendor environments**: Industry standard works across different vendors
- **Data centers**: Provides fast convergence and efficient route calculation
- **Campus networks**: Scales well for large campus deployments
- **WAN connectivity**: Used for routing between branch offices and headquarters
- **Cloud connectivity**: Used in hybrid cloud scenarios

## Best Practices

- Use area 0 for single-area OSPF designs
- Configure loopback interfaces on all routers for stable RIDs
- Manually configure RIDs for predictability
- Use `ip ospf` interface command instead of network command when possible
- Configure passive interfaces on loopback and host-facing interfaces
- Set consistent reference bandwidth across all routers
- Use point-to-point network type on direct router-to-router links
- Monitor neighbor relationships and routing table
- Document OSPF area design and router roles
- Use authentication in production environments (beyond CCNA scope)

## Summary

- OSPF is an open standard link-state routing protocol using SPF (Dijkstra's) algorithm
- OSPFv2 is for IPv4 and is the CCNA exam focus
- Routers exchange LSAs to build LSDB, which serves as network topology map
- OSPF areas divide large networks; area 0 is backbone area
- Router types: internal, backbone, ABR, ASBR
- Route types: intra-area, inter-area, external
- OSPF cost is cumulative cost of interfaces in path; calculated from reference bandwidth / link bandwidth
- Default reference bandwidth is 100 Mbps; should be adjusted for modern networks
- Router ID must be unique; determined by manual config, loopback IP, or highest physical interface IP
- Activate OSPF with network command or `ip ospf` interface command
- Passive interfaces don't send hello messages but still advertise prefixes
- OSPF uses five message types: hello, DBD, LSR, LSU, LSAck
- Seven neighbor states: Down, Init, 2-Way, ExStart, Exchange, Loading, Full
- Broadcast network type elects DR/BDR; point-to-point doesn't
- DR/BDR election based on interface priority (default 1) then RID
- Neighbor requirements: area, subnet, timers, authentication, IP MTU, network type must match; RIDs must be unique
- IP MTU mismatch prevents full adjacency; network type mismatch prevents LSDB sync
- Use verification commands to troubleshoot neighbor relationships and routing issues

